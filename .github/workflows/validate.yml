name: Validate and Deploy

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment, skipping runs queued between the run in-progress and latest queued.
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # Job 1: Basic Validation
  validate:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Make validation scripts executable
      run: chmod +x validate-website.sh tests/*.sh 2>/dev/null || chmod +x validate-website.sh
    
    - name: Run website validation
      run: ./validate-website.sh
    
    - name: Check for console errors in JavaScript
      run: |
        echo "ğŸ” Checking for common JavaScript issues..."
        
        # Check for console.log statements (optional warning)
        CONSOLE_LOGS=$(grep -r "console.log" js/*.js --include="*.js" | wc -l || echo "0")
        if [ "$CONSOLE_LOGS" -gt 0 ]; then
          echo "âš ï¸  Found $CONSOLE_LOGS console.log statements (consider removing for production)"
        fi
        
        # Check for debugger statements
        if grep -r "debugger" js/*.js --include="*.js" > /dev/null 2>&1; then
          echo "âŒ Found debugger statements - remove before deployment!"
          exit 1
        fi
        
        echo "âœ… No critical JavaScript issues found"

  # Job 2: Trip Data Validation
  trip-data-validation:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Validate Trip Data Structure
      run: |
        echo "ğŸ—ºï¸ Validating trip data structure..."
        
        # Check tripsData exists
        if grep -q "const tripsData" js/trips-data.js; then
          echo "âœ… tripsData object defined"
        else
          echo "âŒ tripsData not found"
          exit 1
        fi
        
        # Count trips
        TRIP_COUNT=$(grep -c "isActive:" js/trips-data.js || echo "0")
        echo "ğŸ“Š Found $TRIP_COUNT trips with isActive flag"
        
        if [ "$TRIP_COUNT" -lt 25 ]; then
          echo "âŒ Expected at least 25 trips, found $TRIP_COUNT"
          exit 1
        fi
        
        # Check required fields exist
        for field in "title:" "price:" "image:" "duration:" "difficulty:" "location:"; do
          COUNT=$(grep -c "$field" js/trips-data.js || echo "0")
          if [ "$COUNT" -gt 0 ]; then
            echo "âœ… Field $field found ($COUNT occurrences)"
          else
            echo "âŒ Field $field not found"
            exit 1
          fi
        done
        
        echo "âœ… Trip data structure is valid"

  # Job 3: Common Data Validation  
  common-data-validation:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Validate Common Data Objects
      run: |
        echo "ğŸ“‹ Validating common data objects..."
        
        # Check commonPickupPoints
        if grep -q "const commonPickupPoints" js/trips-data.js; then
          PICKUP_COUNT=$(grep -A 30 "commonPickupPoints" js/trips-data.js | grep -c "name:" || echo "0")
          echo "âœ… commonPickupPoints has $PICKUP_COUNT locations"
          if [ "$PICKUP_COUNT" -lt 4 ]; then
            echo "âš ï¸ Expected at least 4 pickup points"
          fi
        else
          echo "âŒ commonPickupPoints not found"
          exit 1
        fi
        
        # Check commonCancellationPolicy
        if grep -q "const commonCancellationPolicy" js/trips-data.js; then
          echo "âœ… commonCancellationPolicy defined"
        else
          echo "âŒ commonCancellationPolicy not found"
          exit 1
        fi
        
        # Check commonGuidelines
        if grep -q "const commonGuidelines" js/trips-data.js; then
          echo "âœ… commonGuidelines defined"
        else
          echo "âŒ commonGuidelines not found"
          exit 1
        fi
        
        # Check commonFAQs
        if grep -q "const commonFAQs" js/trips-data.js; then
          echo "âœ… commonFAQs defined"
        else
          echo "âŒ commonFAQs not found"
          exit 1
        fi
        
        echo "âœ… All common data objects valid"

  # Job 4: JavaScript Validation
  javascript-validation:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Validate JavaScript Syntax
      run: |
        echo "ğŸ”§ Validating JavaScript syntax..."
        
        for file in js/*.js; do
          if [ -f "$file" ]; then
            if node --check "$file" 2>/dev/null; then
              echo "âœ… $file - syntax valid"
            else
              echo "âŒ $file - syntax error"
              exit 1
            fi
          fi
        done
        
        echo "âœ… All JavaScript files have valid syntax"

  # Job 5: HTML Validation
  html-validation:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Validate HTML Structure
      run: |
        echo "ğŸ“„ Validating HTML files..."
        
        HTML_FILES=("index.html" "trips.html" "trip-detail.html" "checkout.html" "about.html" "contact.html")
        
        for file in "${HTML_FILES[@]}"; do
          if [ -f "$file" ]; then
            # Check DOCTYPE
            if head -5 "$file" | grep -qi "<!DOCTYPE html>"; then
              echo "âœ… $file has DOCTYPE"
            else
              echo "âŒ $file missing DOCTYPE"
              exit 1
            fi
            
            # Check basic structure
            if grep -q "<html" "$file" && grep -q "</html>" "$file"; then
              echo "âœ… $file has valid HTML tags"
            else
              echo "âŒ $file missing HTML tags"
              exit 1
            fi
            
            # Check viewport meta
            if grep -q 'viewport' "$file"; then
              echo "âœ… $file has viewport meta"
            else
              echo "âš ï¸ $file missing viewport meta"
            fi
          else
            echo "âŒ $file not found"
            exit 1
          fi
        done
        
        echo "âœ… HTML validation passed"

  # Job 6: CSS Validation
  css-validation:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Validate CSS Files
      run: |
        echo "ğŸ¨ Validating CSS files..."
        
        CSS_FILES=("css/style.css" "css/pages.css" "css/responsive.css")
        
        for file in "${CSS_FILES[@]}"; do
          if [ -f "$file" ]; then
            # Check for balanced braces
            OPEN=$(grep -o "{" "$file" | wc -l)
            CLOSE=$(grep -o "}" "$file" | wc -l)
            
            if [ "$OPEN" -eq "$CLOSE" ]; then
              echo "âœ… $file has balanced braces ($OPEN pairs)"
            else
              echo "âŒ $file has unbalanced braces (open: $OPEN, close: $CLOSE)"
              exit 1
            fi
            
            # Check file not empty
            if [ -s "$file" ]; then
              echo "âœ… $file is not empty"
            else
              echo "âŒ $file is empty"
              exit 1
            fi
          else
            echo "âŒ $file not found"
            exit 1
          fi
        done
        
        echo "âœ… CSS validation passed"

  # Job 7: Inactive Trip Feature Validation
  inactive-trip-validation:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Validate Inactive Trip Feature
      run: |
        echo "ğŸ”’ Validating inactive trip feature..."
        
        # Check CSS classes exist
        if grep -q "trip-inactive" css/style.css; then
          echo "âœ… trip-inactive CSS class defined"
        else
          echo "âŒ trip-inactive CSS class not found"
          exit 1
        fi
        
        if grep -q "inactive-trip-banner" css/style.css; then
          echo "âœ… inactive-trip-banner CSS defined"
        else
          echo "âŒ inactive-trip-banner CSS not found"
          exit 1
        fi
        
        if grep -q "booking-disabled" css/style.css; then
          echo "âœ… booking-disabled CSS defined"
        else
          echo "âŒ booking-disabled CSS not found"
          exit 1
        fi
        
        # Check JS handles inactive trips
        if grep -q "isActive" trip-detail.html; then
          echo "âœ… trip-detail.html handles inactive trips"
        else
          echo "âŒ trip-detail.html doesn't handle inactive trips"
          exit 1
        fi
        
        if grep -q "isActive" trips.html; then
          echo "âœ… trips.html handles inactive trips"
        else
          echo "âŒ trips.html doesn't handle inactive trips"
          exit 1
        fi
        
        # Count trips with isActive flag
        ACTIVE_TRUE=$(grep -c "isActive: true" js/trips-data.js || echo "0")
        ACTIVE_FALSE=$(grep -c "isActive: false" js/trips-data.js || echo "0")
        
        echo "ğŸ“Š Active trips: $ACTIVE_TRUE"
        echo "ğŸ“Š Inactive trips: $ACTIVE_FALSE"
        
        echo "âœ… Inactive trip feature validation passed"

  # Job 8: Images Validation
  images-validation:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Validate Images
      run: |
        echo "ğŸ–¼ï¸ Validating images..."
        
        # Count trip images
        TRIP_IMAGES=$(find images/trips -name "*.jpg" -o -name "*.png" -o -name "*.webp" 2>/dev/null | wc -l)
        echo "ğŸ“Š Found $TRIP_IMAGES trip images"
        
        if [ "$TRIP_IMAGES" -lt 20 ]; then
          echo "âš ï¸ Expected at least 20 trip images"
        fi
        
        # Check for large images (over 500KB)
        LARGE_IMAGES=$(find images -type f \( -name "*.jpg" -o -name "*.png" -o -name "*.webp" \) -size +500k 2>/dev/null | wc -l)
        
        if [ "$LARGE_IMAGES" -gt 0 ]; then
          echo "âš ï¸ Found $LARGE_IMAGES images over 500KB - consider optimizing"
          find images -type f \( -name "*.jpg" -o -name "*.png" -o -name "*.webp" \) -size +500k 2>/dev/null
        else
          echo "âœ… No oversized images"
        fi
        
        echo "âœ… Images validation passed"

  # Job 9: Security Check
  security-check:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Security Checks
      run: |
        echo "ğŸ” Running security checks..."
        
        # Check for exposed API keys (pattern matching)
        if grep -rE "(api_key|apikey|API_KEY|secret_key|SECRET_KEY|password|PASSWORD).*=.*['\"][^'\"]{10,}['\"]" js/*.js 2>/dev/null; then
          echo "âš ï¸ Potential exposed secrets found - review above matches"
        else
          echo "âœ… No obvious exposed secrets"
        fi
        
        # Check for inline scripts with sensitive data
        if grep -l "rzp_live_\|rzp_test_" *.html 2>/dev/null; then
          echo "âš ï¸ Razorpay keys found in HTML - ensure they are public keys only"
        fi
        
        # Check security.js exists
        if [ -f "js/security.js" ]; then
          echo "âœ… security.js exists"
        else
          echo "âš ï¸ security.js not found"
        fi
        
        echo "âœ… Security check completed"

  # Job 10: Mobile Responsive Check
  mobile-responsive-check:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Check Mobile Responsiveness
      run: |
        echo "ğŸ“± Checking mobile responsiveness..."
        
        # Check viewport meta tags
        for file in index.html trips.html trip-detail.html checkout.html; do
          if [ -f "$file" ]; then
            if grep -q 'viewport.*width=device-width' "$file"; then
              echo "âœ… $file has proper viewport meta"
            else
              echo "âš ï¸ $file may have incorrect viewport"
            fi
          fi
        done
        
        # Check for media queries in responsive.css
        if [ -f "css/responsive.css" ]; then
          MEDIA_QUERIES=$(grep -c "@media" css/responsive.css || echo "0")
          echo "ğŸ“Š Found $MEDIA_QUERIES media queries in responsive.css"
          
          if [ "$MEDIA_QUERIES" -lt 3 ]; then
            echo "âš ï¸ Expected at least 3 media queries for responsive design"
          else
            echo "âœ… Adequate media queries for responsive design"
          fi
        fi
        
        # Check for mobile menu
        if grep -q "mobile-menu\|hamburger\|nav-toggle" css/style.css; then
          echo "âœ… Mobile menu styles found"
        else
          echo "âš ï¸ Mobile menu styles not found"
        fi
        
        echo "âœ… Mobile responsive check completed"

  # Job 11: Run Comprehensive Test Scripts (if available)
  comprehensive-tests:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Run Test Scripts
      run: |
        if [ -d "tests" ] && [ -f "tests/run-all-tests.sh" ]; then
          chmod +x tests/*.sh
          ./tests/run-all-tests.sh
        else
          echo "â„¹ï¸ No test scripts directory found, skipping"
        fi

  # Job 12: Test Summary
  test-summary:
    needs: [validate, trip-data-validation, common-data-validation, javascript-validation, html-validation, css-validation, inactive-trip-validation, images-validation, security-check, mobile-responsive-check, comprehensive-tests]
    runs-on: ubuntu-latest
    if: always()
    steps:
    - name: Test Summary
      run: |
        echo ""
        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo "â•‘              VALIDATION & TEST SUMMARY                        â•‘"
        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        echo "Jobs completed. Check individual job results above."
        echo ""
        
        if [ "${{ needs.validate.result }}" == "success" ] && \
           [ "${{ needs.trip-data-validation.result }}" == "success" ] && \
           [ "${{ needs.javascript-validation.result }}" == "success" ] && \
           [ "${{ needs.html-validation.result }}" == "success" ] && \
           [ "${{ needs.css-validation.result }}" == "success" ]; then
          echo "âœ… All critical validations passed!"
        else
          echo "âŒ Some validations failed - check job details"
          exit 1
        fi

  # Job 13: Deploy to GitHub Pages (only runs if all validations pass)
  deploy:
    needs: [validate, trip-data-validation, javascript-validation, html-validation, css-validation, inactive-trip-validation]
    if: (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master') && success()
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Setup Pages
      uses: actions/configure-pages@v4
    
    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: '.'
    
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
    
    - name: Deployment Summary
      run: |
        echo ""
        echo "================================================"
        echo "ğŸš€ Website deployed successfully!"
        echo "ğŸ“ URL: ${{ steps.deployment.outputs.page_url }}"
        echo "================================================"
